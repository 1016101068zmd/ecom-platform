<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>è´­ç‰©è½¦</title>
<link rel="stylesheet" href="style.css">
<style>
  body {
    font-family: Arial, "Microsoft YaHei", sans-serif;
    background: #f5f6fa;
    margin: 0;
    padding: 0;
  }

  .navbar {
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .navbar h3 {
    margin: 0;
    color: #333;
    font-size: 20px;
  }

  .navbar button {
    padding: 8px 16px;
    border: 1px solid #ddd;
    background: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
  }

  .navbar button:hover {
    background: #f0f0f0;
  }

  .navbar button.primary {
    background: #d46db9;
    color: #fff;
    border-color: #d46db9;
  }

  .navbar button.primary:hover {
    background: #ef62d5;
  }

  #cartList {
    max-width: 800px;
    margin: 20px auto;
    padding: 0 20px;
  }

  .cart-item {
    background: #fff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,.06);
  }

  .cart-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .cart-item span {
    flex: 1;
    font-size: 16px;
    color: #333;
    cursor: pointer;
  }

  .cart-item span:hover {
    color: #d46db9;
  }

  .cart-item .controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .cart-item button {
    width: 32px;
    height: 32px;
    border: 1px solid #ddd;
    background: #fff;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
  }

  .cart-item button:hover {
    background: #f0f0f0;
  }

  .cart-item button.delete {
    background: #ff4757;
    color: #fff;
    border-color: #ff4757;
  }

  .cart-item button.delete:hover {
    background: #ff3838;
  }

  .cart-footer {
    max-width: 800px;
    margin: 20px auto;
    padding: 20px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: bold;
  }

  .cart-footer #total {
    color: #e74c3c;
    font-size: 24px;
  }

  .empty-cart {
    text-align: center;
    padding: 60px 20px;
    color: #999;
  }

  .loading {
    text-align: center;
    padding: 60px 20px;
    color: #999;
  }
</style>
</head>
<body>

<header class="navbar">
  <button onclick="history.back()">â† è¿”å›</button>
  <h3>è´­ç‰©è½¦</h3>
  <button class="primary" onclick="buySelected()">ç«‹å³è´­ä¹°</button>
</header>

<div id="cartList">
  <div class="loading">åŠ è½½ä¸­...</div>
</div>

<div class="cart-footer">
  <span>æ€»ä»·ï¼šï¿¥<span id="total">0</span></span>
  <button class="primary" onclick="buySelected()" style="padding: 10px 24px; border: none;">ç»“ç®—</button>
</div>

<script>
  const API_BASE = "http://localhost:3000/api";
  let cartData = []; // å­˜å‚¨è´­ç‰©è½¦æ•°æ®

  /**********************
   * åŠ è½½è´­ç‰©è½¦æ•°æ®
   **********************/
  async function loadCart() {
    const userId = localStorage.getItem("userId");
    const token = localStorage.getItem("token");

    if (!userId || !token) {
      alert("è¯·å…ˆç™»å½•");
      location.href = "index.html";
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/cart/${userId}`, {
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });

      if (!res.ok) {
        throw new Error("åŠ è½½è´­ç‰©è½¦å¤±è´¥");
      }

      cartData = await res.json();
      
      // ä¸ºæ¯ä¸ªå•†å“æ·»åŠ  checked å±æ€§ï¼ˆé»˜è®¤é€‰ä¸­ï¼‰
      cartData = cartData.map(item => ({
        ...item,
        checked: true
      }));

      render();

    } catch (err) {
      console.error(err);
      document.getElementById("cartList").innerHTML = 
        '<div class="empty-cart">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
    }
  }

  /**********************
   * æ¸²æŸ“è´­ç‰©è½¦
   **********************/
  function render() {
    const cartList = document.getElementById("cartList");
    
    if (cartData.length === 0) {
      cartList.innerHTML = '<div class="empty-cart">è´­ç‰©è½¦æ˜¯ç©ºçš„</div>';
      document.getElementById("total").innerText = "0";
      return;
    }

    let sum = 0;

    cartList.innerHTML = cartData.map((item, idx) => {
      // åªç»Ÿè®¡å‹¾é€‰å•†å“é‡‘é¢
      if (item.checked) {
        sum += item.price * item.quantity;
      }

      return `
        <div class="cart-item">
          <input type="checkbox"
            ${item.checked ? "checked" : ""}
            onchange="toggleCheck(${idx}, this.checked)"
          >
          <span onclick="location.href='product.html?id=${item.product_id}'">
            ${item.name} - Â¥${item.price}
          </span>
          <div class="controls">
            <button onclick="changeQuantity(${idx}, -1)">-</button>
            <span>${item.quantity}</span>
            <button onclick="changeQuantity(${idx}, 1)">+</button>
            <button class="delete" onclick="deleteItem(${idx})">ğŸ—‘</button>
          </div>
        </div>
      `;
    }).join("");

    document.getElementById("total").innerText = sum.toFixed(2);
  }

  /**********************
   * å‹¾é€‰ / å–æ¶ˆå‹¾é€‰
   **********************/
  function toggleCheck(index, checked) {
    cartData[index].checked = checked;
    render();
  }

  /**********************
   * ä¿®æ”¹æ•°é‡
   **********************/
  async function changeQuantity(index, delta) {
    const item = cartData[index];
    const newQuantity = item.quantity + delta;

    if (newQuantity <= 0) {
      // æ•°é‡ä¸º0ï¼Œåˆ é™¤å•†å“
      deleteItem(index);
      return;
    }

    const token = localStorage.getItem("token");

    try {
      const res = await fetch(`${API_BASE}/cart/${item.id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ quantity: newQuantity })
      });

      if (!res.ok) {
        throw new Error("æ›´æ–°å¤±è´¥");
      }

      // æ›´æ–°æœ¬åœ°æ•°æ®
      cartData[index].quantity = newQuantity;
      render();

    } catch (err) {
      console.error(err);
      alert("æ›´æ–°æ•°é‡å¤±è´¥");
    }
  }

  /**********************
   * åˆ é™¤å•†å“
   **********************/
  async function deleteItem(index) {
    if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ")) {
      return;
    }

    const item = cartData[index];
    const token = localStorage.getItem("token");

    try {
      const res = await fetch(`${API_BASE}/cart/${item.id}`, {
        method: "DELETE",
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });

      if (!res.ok) {
        throw new Error("åˆ é™¤å¤±è´¥");
      }

      // ä»æœ¬åœ°æ•°æ®ä¸­ç§»é™¤
      cartData.splice(index, 1);
      render();

    } catch (err) {
      console.error(err);
      alert("åˆ é™¤å¤±è´¥");
    }
  }

  /**********************
   * âœ… ç«‹å³è´­ä¹°ï¼ˆåˆ›å»ºè®¢å•ï¼‰
   **********************/
  async function buySelected() {
    const selected = cartData.filter(item => item.checked);

    if (selected.length === 0) {
      alert("è¯·é€‰æ‹©è¦è´­ä¹°çš„å•†å“");
      return;
    }

    const userId = localStorage.getItem("userId");
    const token = localStorage.getItem("token");

    if (!userId || !token) {
      alert("è¯·å…ˆç™»å½•");
      location.href = "index.html";
      return;
    }

    // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
    const buttons = document.querySelectorAll('.primary');
    buttons.forEach(btn => {
      btn.disabled = true;
      btn.textContent = "æäº¤ä¸­...";
    });

    try {
      // âœ… è°ƒç”¨åç«¯åˆ›å»ºè®¢å•API
      const res = await fetch(`${API_BASE}/orders`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ user_id: userId })
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || "ä¸‹å•å¤±è´¥");
      }

      // âœ… è®¢å•åˆ›å»ºæˆåŠŸ
      alert(`è´­ä¹°æˆåŠŸï¼è®¢å•å·ï¼š${data.order_id}\næ€»é‡‘é¢ï¼šï¿¥${document.getElementById("total").innerText}`);
      
      // é‡æ–°åŠ è½½è´­ç‰©è½¦ï¼ˆè´­ç‰©è½¦åº”è¯¥å·²è¢«æ¸…ç©ºï¼‰
      await loadCart();

    } catch (err) {
      console.error(err);
      alert(err.message || "ä¸‹å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
      
      // æ¢å¤æŒ‰é’®çŠ¶æ€
      buttons.forEach(btn => {
        btn.disabled = false;
        btn.textContent = btn.classList.contains('navbar') ? "ç«‹å³è´­ä¹°" : "ç»“ç®—";
      });
    }
  }

  // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
  loadCart();
</script>

</body>
</html>