<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>商品管理</title>
  <link rel="stylesheet" href="layout.css" />
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #4b7bec;
      color: #fff;
    }
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      background: #4b7bec;
      color: #fff;
      cursor: pointer;
      margin: 0 4px;
    }
    button:hover {
      background: #3867d6;
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="side">
      <div class="brand">电商管理后台</div>
      <nav class="nav">
        <a href="products.html" class="active">商品管理</a>
        <a href="orders.html">订单管理</a>
      </nav>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <div style="font-size:16px;font-weight:700;">商品管理</div>
          <div class="muted">管理所有商品信息</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          <span id="adminName" style="color:#333;"></span>
          <button class="btn" onclick="addProduct()">+ 新增商品</button>
          <button class="btn-ghost" onclick="logout()">退出登录</button>
        </div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>商品名</th>
              <th>分类</th>
              <th>价格</th>
              <th>库存</th>
              <th>状态</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </main>
  </div>

  <script src="auth.js"></script>
  <script src="ui.js"></script>
  <script>
    // 改回 localhost
    const API_BASE = "http://localhost:3000/api";
    
    AUTH.requireLogin();
    document.getElementById("adminName").textContent = AUTH.name;

    let products = [];

    async function adminFetch(url, options = {}) {
      const headers = {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${AUTH.token}`
      };
      const res = await fetch(url, { ...options, headers });
      if (res.status === 401 || res.status === 403) {
        alert("登录过期，请重新登录");
        AUTH.logout();
        location.href = "login.html";
        return null;
      }
      return res;
    }

    async function loadProducts() {
      try {
        const res = await fetch(API_BASE + "/products");
        products = await res.json();
        renderProducts(products);
      } catch (e) {
        alert("加载商品失败: " + e.message);
      }
    }

    function renderProducts(list) {
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = list.map(p => `
        <tr>
          <td>${p.id}</td>
          <td>${p.name}</td>
          <td>${p.category || "-"}</td>
          <td>￥${p.price}</td>
          <td>${p.stock}</td>
          <td>${p.status}</td>
          <td>
            <button onclick="editProduct(${p.id})">编辑</button>
            <button onclick="delProduct(${p.id})" style="background:#e74c3c;">删除</button>
          </td>
        </tr>
      `).join("");
    }

    async function addProduct() {
      const data = await UI.productForm(); 
      if (!data) return;

      const res = await adminFetch(API_BASE + "/admin/products", {
        method: "POST",
        body: JSON.stringify(data)
      });
      if (res) {
        alert("新增成功");
        loadProducts();
      }
    }

    async function editProduct(id) {
      const p = products.find(x => x.id === id);
      const data = await UI.productForm(p);
      if (!data) return;

      const res = await adminFetch(API_BASE + `/admin/products/${id}`, {
        method: "PUT",
        body: JSON.stringify(data)
      });
      if (res) {
        alert("更新成功");
        loadProducts();
      }
    }

    async function delProduct(id) {
      const ok = await UI.confirmBox("确定要删除此商品吗？");
      if (!ok) return;

      const res = await adminFetch(API_BASE + `/admin/products/${id}`, {
        method: "DELETE"
      });
      if (res) {
        alert("已删除");
        loadProducts();
      }
    }

    function logout() {
      AUTH.logout();
      location.href = "login.html";
    }

    loadProducts();
  </script>
</body>
</html>