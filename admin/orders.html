<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>订单管理</title>
  <style>
    body{font-family:Arial,"Microsoft YaHei",sans-serif;background:#f5f6fa;margin:0;padding:24px;}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;}
    h2{margin:0;color:#333;}
    button{
      padding:9px 12px;border:none;border-radius:8px;background:#4b7bec;color:#fff;cursor:pointer;
    }
    button:hover{background:#3867d6;}
    .ghost{background:#fff;color:#4b7bec;border:1px solid #cbd6ff;}
    .ghost:hover{background:#eef2ff;}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;}
    th,td{padding:12px;border-bottom:1px solid #eee;text-align:center;font-size:14px;}
    th{background:#4b7bec;color:#fff;}
    select,input{
      padding:7px 8px;border-radius:7px;border:1px solid #ddd;background:#fff;outline:none;
    }
    select:focus,input:focus{border-color:#4b7bec;}
    .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .tag{
      display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;
    }
    .tag.done{background:#e1f5d3;color:#2d7a18;}
    .tag.cancel{background:#ffe9e3;color:#c0392b;}
  </style>
</head>
<body>
  <script>
    // 登录守卫
    if (localStorage.getItem("admin_logged") !== "1") {
      location.href = "login.html";
    }
  </script>

  <div class="top">
    <h2>订单管理</h2>
    <div class="filters">
      <input id="kwOrder" placeholder="按订单号搜索" />
      <select id="statusFilter">
        <option value="">全部状态</option>
        <option value="待支付">待支付</option>
        <option value="已支付">已支付</option>
        <option value="已发货">已发货</option>
        <option value="已完成">已完成</option>
        <option value="已取消">已取消</option>
      </select>
      <button class="ghost" onclick="location.href='products.html'">返回商品管理</button>
      <button class="ghost" id="logoutBtn">退出登录</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>订单号</th><th>用户</th><th>金额</th><th>状态</th><th>操作</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    const STORAGE_KEY_ORDERS = "admin_orders";
    const ALL_STATUSES = ["待支付","已支付","已发货","已完成","已取消"];

    // 合法状态流转表
    const FLOW = {
      "待支付": ["已支付","已取消"],
      "已支付": ["已发货","已取消"],
      "已发货": ["已完成"],
      "已完成": [],
      "已取消": []
    };

    function loadOrders() {
      const raw = localStorage.getItem(STORAGE_KEY_ORDERS);
      if (raw) {
        try { return JSON.parse(raw); } catch {}
      }
      const init = [
        {no:"OD2025001", user:"张三", amount:199, status:"待支付"},
        {no:"OD2025002", user:"李四", amount:59,  status:"已支付"},
        {no:"OD2025003", user:"王五", amount:129, status:"已发货"},
      ];
      localStorage.setItem(STORAGE_KEY_ORDERS, JSON.stringify(init));
      return init;
    }

    function saveOrders(list) {
      localStorage.setItem(STORAGE_KEY_ORDERS, JSON.stringify(list));
    }

    let orders = loadOrders();

    const tbody = document.getElementById("tbody");
    const kwInput = document.getElementById("kwOrder");
    const statusFilter = document.getElementById("statusFilter");

    function filteredOrders() {
      const kw = kwInput.value.trim();
      const st = statusFilter.value;
      return orders.filter(o => {
        if (kw && !o.no.includes(kw)) return false;
        if (st && o.status !== st) return false;
        return true;
      });
    }

    function render() {
      const list = filteredOrders();
      tbody.innerHTML = list.map((o, idx) => {
        const fullIndex = orders.findIndex(x => x.no === o.no); // 为了保存时定位
        return `
        <tr>
          <td>${o.no}</td>
          <td>${o.user}</td>
          <td>¥${o.amount}</td>
          <td>
            <span class="tag ${
              o.status === "已完成" ? "done" :
              o.status === "已取消" ? "cancel" : ""
            }">
              ${o.status}
            </span>
          </td>
          <td>
            <select id="st_${fullIndex}">
              ${ALL_STATUSES.map(s=>{
                const canTransition = (s === o.status) || FLOW[o.status].includes(s);
                return `<option value="${s}" ${s===o.status?"selected":""} ${canTransition?"":"disabled"}>${s}${canTransition?"":" (不可直接跳转)"}</option>`;
              }).join("")}
            </select>
            <button onclick="saveStatus(${fullIndex})">保存状态</button>
          </td>
        </tr>`;
      }).join("");
    }

    function saveStatus(index) {
      const sel = document.getElementById("st_"+index);
      if (!sel) return;
      const newStatus = sel.value;
      const o = orders[index];
      if (!o) return;

      const from = o.status;
      if (newStatus === from) {
        alert("状态未变化");
        return;
      }
      if (!FLOW[from].includes(newStatus)) {
        alert("不允许从「"+from+"」直接变为「"+newStatus+"」");
        sel.value = from;
        return;
      }
      if (!confirm(`确认将订单 ${o.no} 状态由「${from}」改为「${newStatus}」吗？`)) {
        sel.value = from;
        return;
      }

      o.status = newStatus;
      saveOrders(orders);
      alert("订单状态已更新：" + o.no + " -> " + newStatus);
      render();
    }

    kwInput.addEventListener("input", render);
    statusFilter.addEventListener("change", render);

    document.getElementById("logoutBtn").addEventListener("click", () => {
      if (confirm("确认退出登录吗？")) {
        localStorage.removeItem("admin_logged");
        location.href = "login.html";
      }
    });

    render();
  </script>
</body>
</html>
